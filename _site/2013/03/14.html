<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="description" content="在 Linux 下使用 SSH 代理（socks5 代理）实现 Windows 下的全局代理上网。需要安装 Redsocks 和 Proxychains，再使用 iptables 端口转发。实现全局代理上网" />
    <meta name="author" content="唐久军">
    
    <link rel="shortcut icon" href="/assets/img/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" type="text/css" href="/assets/css/blog.css">
    <script type="text/javascript" src="/assets/js/blog.js"></script>

    <title>Linux 下设置 Ssh 全局代理上网</title>

    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-39325120-3']);
        _gaq.push(['_trackPageview']);

        (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
      </script>

  </head>

  <body>
<div class="nav nav-fix-top">
    <div class="navbar-panel">
        <div class="brand">
            <a href="/" class="light">唐久军的博客</a>
        </div>

        <div class="catalog pull-right">
            <ul>
                <li><a href="/categories.html">分类</a></li>
                <li><a href="/tags.html">标签</a></li>
                <li><a href="/projects.html">项目</a></li>
                <li><a href="/archives.html">归档</a></li>
                <li><a href="/about_me.html">关于我</a></li>
            </ul>
        </div>
    </div>
</div>

<!-- 防止 IE6、7 中定位元素导致相邻元素 margin-top 失效 -->
<div style="height: 0px"></div>
  <div class="well well-header">
      <ul>
          <li  class="badge badge-info badge-large pull-right">
            <a href="/categories.html?#anchor服务器">分类：服务器</a></li>
      </ul>
      <ul>
        
          <li  class="badge badge-inverse pull-right">
              <a href="/tags.html?#anchorLinux">Linux</a>
          </li>
        
          <li  class="badge badge-inverse pull-right">
              <a href="/tags.html?#anchorSSH">SSH</a>
          </li>
        
      </ul>

      <a class="time-backgroud"></a>
      <span class="time-meta">2013年03月14日</span>
      <h1>Linux 下设置 Ssh 全局代理上网</h1>
      <hr>
      <p>在 Linux 下使用 SSH 代理（socks5 代理）实现 Windows 下的全局代理上网。需要安装 Redsocks 和 Proxychains，再使用 iptables 端口转发。实现全局代理上网</p>
  </div>

  <div class="well">
    <h3>安装必备软件</h3>
<div class="highlight"><pre><code class="text language-text" data-lang="text">aptitude install proxychains redsocks
# 在 Debian 6 Testing 或 Debian 7 中才有 redsocks。Debian 6 中可以直接下载相应的 deb 包，经测试可以直接安装
</code></pre></div>
<h3>连接 SSH 服务器</h3>
<div class="highlight"><pre><code class="text language-text" data-lang="text">ssh -qTfNn -D 7070 username@ssh_server_domain_or_ip
</code></pre></div>
<h3>配置 Redsocks</h3>

<ol>
<li><p>新建 redsocks.conf 配置文件。内容如下,不用修改，直接保存：</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">base {
  // debug: connection progress &amp; client list on SIGUSR1
  log_debug = off;

  // info: start and end of client session
  log_info = on;

  /* possible `log&#39; values are:
   *   stderr
   *   &quot;file:/path/to/file&quot;
   *   syslog:FACILITY  facility is any of &quot;daemon&quot;, &quot;local0&quot;...&quot;local7&quot;
   */
  log = &quot;syslog:daemon&quot;;

  // detach from console
  daemon = on;

  /* Change uid, gid and root directory, these options require root
   * privilegies on startup.
   * Note, your chroot may requre /etc/localtime if you write log to syslog.
   * Log is opened before chroot &amp; uid changing.
   */
  // user = redsocks;
  // group = redsocks;
  // chroot = &quot;/var/chroot&quot;;

  /* possible `redirector&#39; values are:
   *   iptables   - for Linux
   *   ipf        - for FreeBSD
   *   pf         - for OpenBSD
   *   generic    - some generic redirector that MAY work
   */
  redirector = iptables;
}

redsocks {
  /* `local_ip&#39; defaults to 127.0.0.1 for security reasons,
   * use 0.0.0.0 if you want to listen on every interface.
   * `local_*&#39; are used as port to redirect to.
   */
  local_ip = 127.0.0.1;
  local_port = 12345;

  // `ip&#39; and `port&#39; are IP and tcp-port of proxy-server
  // You can also use hostname instead of IP, only one (random)
  // address of multihomed host will be used.
  ip = 127.0.0.1;
  port = 7070;

  // known types: socks4, socks5, http-connect, http-relay
  type = socks5;

  // login = &quot;foobar&quot;;
  // password = &quot;baz&quot;;
}

redudp {
  // `local_ip&#39; should not be 0.0.0.0 as it&#39;s also used for outgoing
  // packets that are sent as replies - and it should be fixed
  // if we want NAT to work properly.
  local_ip = 127.0.0.1;
  local_port = 10053;

  // `ip&#39; and `port&#39; of socks5 proxy server.
  ip = 10.0.0.1;
  port = 1080;
  login = username;
  password = pazzw0rd;

  // kernel does not give us this information, so we have to duplicate it
  // in both iptables rules and configuration file.  By the way, you can
  // set `local_ip&#39; to 127.45.67.89 if you need more than 65535 ports to
  // forward ;-)
  // This limitation may be relaxed in future versions using contrack-tools.
  dest_ip = 8.8.8.8;
  dest_port = 53;

  udp_timeout = 30;
  udp_timeout_stream = 180;
}

dnstc {
  // fake and really dumb DNS server that returns &quot;truncated answer&quot; to
  // every query via UDP, RFC-compliant resolver should repeat same query
  // via TCP in this case.
  local_ip = 127.0.0.1;
  local_port = 5300;
}

// you can add more `redsocks&#39; and `redudp&#39; sections if you need.
</code></pre></div></li>
<li><p>编写 redsocks.sh 控制脚本。内容如下，修改处已用中文注明：</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">#! /bin/sh

HOME=/home/tangjiujun        # 设置你的 Home 目录
case &quot;$1&quot; in
  start)
    cd $HOME/temp            # 设置 Redsocks log 文件位置
    if [ -e redsocks.log ] ; then
      rm redsocks.log
    fi

    # 修改 redsocks.pid 文件位置，已经刚才保存的配置文件位置
    redsocks -p $HOME/temp/redsocks.pid -c $HOME/Dropbox/Yunio/shell/etc/redsocks.conf #set daemon = on in config file
    # start redirection
    iptables -t nat -A OUTPUT -p tcp --dport 80 -j REDIRECT --to 12345
    iptables -t nat -A OUTPUT -p tcp --dport 443 -j REDIRECT --to 12345
    ;;

  stop)
    cd $HOME/temp            # 设置 Redsocks log 文件位置
    if [ -e redsocks.pid ]; then
      kill `cat redsocks.pid`
      rm redsocks.pid
    else
      echo already killed, anyway, I will try killall
      killall -9 redsocks
    fi
    # stop redirection
    iptables -t nat -F OUTPUT
    ;;

  clean_dns)
    iptables -A INPUT -p udp --sport 53 -m state --state ESTABLISHED -m gfw -j DROP -m comment --comment &quot;drop gfw dns hijacks&quot;
  ;;
  *)
    echo &quot;Usage: redsocks start|stop|clean_dns&quot; &gt;&amp;2
    exit 3
esac
</code></pre></div></li>
<li><p>打开关闭 redsocks 全局代理</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">./redsocks.sh start
./redsocks.sh stop
</code></pre></div></li>
</ol>

<h3>配置 proxychains</h3>

<p>由上可知， redsocks 只是转发了 80 和 443 端口，因此可以正常上网。但是如果有其他端口需要代理怎么办？ 答案就是用 proxychains</p>

<ol>
<li><p>首先修改 <code>/etc/proxychains.conf</code> 文件，在文件末尾加入：</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">socks5  127.0.0.1 7070
</code></pre></div></li>
<li><p>然后再在要执行的命令前加上 <code>proxychains</code>，例如：</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">proxychains git push
</code></pre></div></li>
</ol>

<p>自此我们就可以在 Linux 下畅游网络了</p>

  </div>

  <!-- 底部导航条 -->
  <div class="nav nav-fix-bottom"  id="nav-fix-bottom">
      <div class="navbar-panel">
          <div id="page-nav-list" class="catalog pull-left"></div>
      </div>
  </div>

  <link rel="stylesheet" type="text/css" href="/assets/css/monokai.min.css">
  <script type="text/javascript" src="/assets/js/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

<!-- duoshuo div -->
<div class="well">
  <div class="ds-thread"></div>
</div>

<!-- Duoshuo Comment BEGIN -->
<script type="text/javascript">
  var duoshuoQuery = {short_name:"tang-blog"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = 'http://static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>
<!-- Duoshuo Comment END -->
<!-- Baidu Button BEGIN -->
<script type="text/javascript" id="bdshare_js" data="type=slide&amp;img=5&amp;mini=1&amp;pos=left&amp;uid=6635097" ></script>
<script type="text/javascript" id="bdshell_js"></script>
<script type="text/javascript">
document.getElementById("bdshell_js").src = "http://bdimg.share.baidu.com/static/js/shell_v2.js?cdnversion=" + Math.ceil(new Date()/3600000);
</script>
<!-- Baidu Button END -->
    <div class="footer">
      &copy; 2013 唐久军 - Crafted with 
        <a href="http://jekyllrb.com/"><strong>Jekyll</strong></a>, Hosted on 
        <strong><a href="https://github.com/">GitHub</a></strong>
        | 转载请遵守 <a href="http://creativecommons.org/licenses/by-sa/3.0/cn/">CC BY-SA 3.0</a> 协议
        <span class="pull-right">
          <strong>
            <a href="https://github.com/tangjiujun">Fork me on GitHub </a>
          </strong>
        </span>
    </div>
  </body>
</html>
